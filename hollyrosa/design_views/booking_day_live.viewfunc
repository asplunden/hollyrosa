{"non_deleted_live_bookings_of_booking_day": {"map": "function(doc) { if (doc.type=='booking' && doc.subtype=='live') { if ((doc.booking_date != '') && (doc.booking_state > -100)) {  if(doc.booking_end_date!='') { if (doc.booking_end_date>doc.booking_date) {var slot_schema_row_length = doc.slot_schema_row.length; var first_slot_id_index = 0; var last_slot_id_index = 0; for (i=0; i < slot_schema_row_length; i=i+1) {if (doc.slot_schema_row[i]['slot_id'] == doc.slot_id) { first_slot_id_index = i; } if (doc.slot_schema_row[i]['slot_id'] == doc.booking_end_slot_id) { last_slot_id_index = i;} } tmp_from_date = new Date(doc.booking_date); tmp_end_date = new Date(doc.booking_end_date); var one_day = 1000*60*60*24; for (tmp_day = tmp_from_date; tmp_day <= tmp_end_date; tmp_day = new Date(tmp_day.getTime() + one_day)) { for (j=first_slot_id_index; j<slot_schema_row_length; j=j+1) { if (tmp_day < tmp_end_date) { emit([tmp_day.getFullYear() + '-' + ('0'+(tmp_day.getMonth()+1)).slice(-2) + '-' + ('0'+tmp_day.getDate()).slice(-2), doc.slot_schema_row[j]['slot_id']], doc);  } else { if ((j<=last_slot_id_index)) { emit([tmp_day.getFullYear() + '-' + ('0'+(tmp_day.getMonth()+1)).slice(-2) + '-' + ('0'+tmp_day.getDate()).slice(-2), doc.slot_schema_row[j]['slot_id'] ],doc); }}   } first_slot_id_index = 0;         } } else { emit([doc.booking_date, doc.slot_id], doc);}    }}}}"}}