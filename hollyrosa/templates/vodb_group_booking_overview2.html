<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--
Copyright 2010, 2011, 2012, 2013 Martin Eliasson

This file is part of Hollyrosa

Hollyrosa is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Hollyrosa is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with Hollyrosa.  If not, see <http://www.gnu.org/licenses/>.

-->

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:py="http://genshi.edgewall.org/" xmlns:hollyrosa="http://asplunden.org/guldkant/hollyrosa" xmlns:xi="http://www.w3.org/2001/XInclude">

  <xi:include href="master.html" />

<head>
  <meta content="text/html; charset=UTF-8" http-equiv="content-type" py:replace="''"/>
  <title>Hollyrosa - Booking Overview 2</title>
  <link rel="stylesheet" type="text/css" href="${tg.url('/scripts/dojo-release-1.8.0/dijit/themes/tundra/tundra.css')}" />
  <link rel="stylesheet" type="text/css" href="${tg.url('/css/gnatt.css')}" />
  
  <script type="text/javascript" src="${tg.url('/scripts/std.js')}" ></script>
  <script src="${tg.url('/scripts/dojo-release-1.8.0/dojo/dojo.js')}" data-dojo-config="async: true" djConfig="parseOnLoad: true, debugAtAllCosts: true"></script>
  <script>

require(["dojo/ready", "tags", "common_menu", "dijit/Menu", "dijit/PopupMenuItem", "dojo/dom", "dojo/dom-attr", "dojo/_base/array", "dojo/query", "dojo/on", "dojo/_base/window", 'dojo/dom-geometry', 'dojo/dom-style'], function(ready, tags, common_menu, Menu, PopupMenuItem, dom, domAttr, array, query, on, win, domGeom, style) {



function startup() {
	//...setup main menu for visiting group  	
	var use_left_click_menu = common_menu.load_left_click_menu();
   	var change_program_status_menu = new Menu();
   
   	var menu = new Menu({
       targetNodeIds: ["title"],
       leftClickToOpen: use_left_click_menu
       });
       

	
   	
	//...create menu for add/edit/show/delete note
	var note_menu = new Menu({
       targetNodeIds: ["content"],
       selector: "div.note2",
       leftClickToOpen: common_menu.load_left_click_menu()
       });
       
    common_menu.add_visiting_group_edit_note_menu_item(note_menu, note_menu, "Edit note...",  '${tg.url('/note/edit_note')}');
    common_menu.add_visiting_group_edit_note_menu_item(note_menu, note_menu, "Delete note...", '${tg.url('/note/delete_note')}');
    
    
    //...create menu for add/edit/show/delete note
	var attachment_menu = new Menu({
       targetNodeIds: ["content"],
       selector: "div.attachment2",
       leftClickToOpen: common_menu.load_left_click_menu()
       });
       
    
    /**** assembling change program state and vodb state menus ***/
    common_menu.add_menu_separator(menu);   
    var change_program_status_menu = new Menu();
    menu.addChild(new PopupMenuItem({
   	label: "Change program status",
      popup: change_program_status_menu,
      leftClickToOpen: common_menu.load_left_click_menu()
   })); 
   
   var set_program_state_url = '${tg.url('/visiting_group/set_program_state')}';       
    
   array.forEach(common_menu.program_state_change_list, function(x) {console.log(x); common_menu.add_change_program_state_menu_item(menu, change_program_status_menu, x['name'], x['state'], 0, set_program_state_url);});
	
	var change_vodb_status_menu = new Menu();
    menu.addChild(new PopupMenuItem({
   	label: "Change vodb status",
      popup: change_vodb_status_menu,
      leftClickToOpen: common_menu.load_left_click_menu()
   })); 
   
   var set_vodb_state_url = '${tg.url('/visiting_group/set_vodb_state')}';       
    
   array.forEach(common_menu.vodb_state_change_list, function(x) {console.log(x); common_menu.add_change_program_state_menu_item(menu, change_vodb_status_menu, x['name'], x['state'], 0, set_vodb_state_url);});
	
	
	};
	
	 



   var header_date_positions = {};
   
    
	ready(function() {
		startup();


      //...build array of header date positions mapping date to a dictionary date, fm, em, evening
      
      var date_header_divs = query('.gnatt_date_header');
      
      array.forEach(date_header_divs, function(date_header_div) {
      	date_header_div_date = domAttr.get(date_header_div, 'hollyrosa:date');
      	//alert(date_header_div_date)
      	tmp_pos = domGeom.position(date_header_div, true);  
         //alert('tmp_pos:'+tmp_pos);
      	header_date_positions[date_header_div_date] = tmp_pos; 
      
      });
      
      alert('header_date_positions:'+header_date_positions);

		//...set vgroup blocks position and width
      var vgroups = query('[hollyrosa:vgid]');
      
      array.forEach(vgroups, function(vgdiv) {
         from_date = vgdiv.attributes['hollyrosa:from_date'];
      	to_date = vgdiv.attributes['hollyrosa:to_date'];
         
         tmp_from_pos = header_date_positions[from_date.value];
         tmp_to_pos = header_date_positions[to_date.value];
         
         
         style.set(vgdiv, {left: tmp_from_pos.x-20+'px', width: (tmp_to_pos.x - tmp_from_pos.x + tmp_to_pos.w) + 'px' });
         });
		
		
		
		//...set vgroup date blocks position and width
		var date_blocks = query('.gnatt_date_block');
      array.forEach(date_blocks, function(date_block) {
         tmp_date = domAttr.get(date_block, 'hollyrosa:date');
         //alert('tmp_date: '+tmp_date);
         //alert(header_date_positions);
         tmp_pos = header_date_positions[tmp_date];
         style.set(date_block, {left: tmp_pos.x+'px', width: tmp_pos.w-2 + 'px' });
         });
         
      });
 });
  </script>
  


</head>

<body class="tundra">
    <h2 id="title">Booking Overview 2</h2> 
<p>From TO</p>

<!-- container div -->
<div style="overflow:visible;">

  <!-- header div row with dates and everyting-->
  <div style="border:1px solid #aaa; overflow:visible; width:300em;">
      <div style="display:inline-block;">Outdoor </div>
      <div py:for="d in header_dates" class="gnatt_date_block gnatt_date_header" hollyrosa:date="$d" style="color:#888;">$d<br/>
          <div py:for="t in header_times" class="gnatt_date_time_block gnatt_date_time_header">
             $t
          </div>
      </div>  
  </div>
  
  
  <!-- first status groud div -->  
  <div style="border:1px solid #866;">
      <!--<div style="border:1px solid #999; display:inline-block;">Status NEW</div>
      <div py:for="d in header_dates" class="gnatt_date_block">$d<br/>
          <div py:for="t in header_times" class="gnatt_date_time_header" >
             $t
          </div>
          
      </div>  
-->
          <div py:for="vg in vgroups" hollyrosa:vgid="$vg.id" hollyrosa:from_date="$vg.from_date" hollyrosa:to_date="$vg.to_date"  class="gnatt_vgroup_block">$vg.boknr $vg.name [$vg.boknstatus]
              <br/><div py:for="d in vg.date_range"  class="gnatt_date_block" hollyrosa:date="$d">             
                  <div py:for="t in header_times"  class="gnatt_date_time_block">                 
                   ${vg['live_computed_by_date'][d+':'+t]} 
                  </div>  
              </div>
          </div>

  
  </div>

</div>

<!-- 
 * Color should depend on bokn status.
 * decipher boknstatus
 * Sort on boknstatus followed by date ?
 * Grid for indor/outdoor/daytrip
 * Context menu on each vgroup div :)
 * Sundays should be red in header ?
 * Add special vgroup at the end summing up all vgroups, but for each bokn stats (?))

-->
    
  
</body>
</html>
