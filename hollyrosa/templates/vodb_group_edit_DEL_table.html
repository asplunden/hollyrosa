<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--
Copyright 2010, 2011, 2012, 2013 Martin Eliasson

This file is part of Hollyrosa

Hollyrosa is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Hollyrosa is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with Hollyrosa.  If not, see <http://www.gnu.org/licenses/>.

-->

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:py="http://genshi.edgewall.org/" xmlns:xi="http://www.w3.org/2001/XInclude">

  <xi:include href="master.html" />

<head>
  <meta content="text/html; charset=UTF-8" http-equiv="content-type" py:replace="''"/>
  <title>Hollyrosa - VODB Group ${vodb_group.name}</title>

  <link rel="stylesheet" type="text/css" href="/css/div_widget.css" />
  <link rel="stylesheet" type="text/css" href="/scripts/dojo-release-1.8.0/dojox/grid/resources/tundraGrid.css" />

  <script>dojoConfig = {parseOnLoad: true}</script>
  <script src="${tg.url('/scripts/dojo-release-1.8.0/dojo/dojo.js')}" data-dojo-config="async: true" djConfig="parseOnLoad: true"></script>
   
  <script>

require(['dojo/_base/lang', 'dojox/grid/DataGrid', 'dojo/data/ItemFileWriteStore', 'dojox/grid/cells/dijit', 'dojo/date/stamp', 'dojo/date/locale', 'dojo/dom','dojo/on','dojo/ready', 'dojo/domReady!'],
  function(lang, DataGrid, ItemFileWriteStore, cells, stamp, locale, dom, on, ready, domReady ){
    
    function formatDate(datum) {
        var d = stamp.fromISOString(datum);
        return locale.format(d, {selector: 'date', formatLength: 'short'});
    }

    function getDateValue(){
        /*Override the default getValue function for dojox.grid.cells.DateTextBox   */
        return stamp.toISOString(this.widget.get('value'));
    }
    
    
    function saveCompleteCallback(){
    	alert('save done');
    	}

	function saveFailedCallback() {
		alert('save failed');
		}
  
 
    var eat_grid_data = { identifier: 'rid',
    items: []  }; //{vodb_group.program_request_age_group}; 
    var live_grid_data = {identifier: 'rid', items:[]}; //{vodb_group.program_request};
    var occu_grid_data = {identifier: 'rid', items:[]}; //{vodb_group.occu_request};
   
    var live_grid_store = new ItemFileWriteStore({
    	data: live_grid_data
   });
   
   
   var eat_grid_store = new ItemFileWriteStore({
    	data: eat_grid_data
   });
   
   
   var occu_grid_store = new ItemFileWriteStore({
    	data: occu_grid_data
   });

    live_grid_store._saveEverything = function(a_saveCompleteCallback /*Your callback to call when save is completed */,
                                a_saveFailedCallback /*Your callback to call if save fails*/,
                                a_newFileContentString /*The generated JSON data to send somewhere*/){
                                
                                	var inp = dom.byId('live_div_input');
                                	inp.value = a_newFileContentString;
                                	a_saveCompleteCallback();
    										};
    
    eat_grid_store._saveEverything = function(a_saveCompleteCallback /*Your callback to call when save is completed */,
                                a_saveFailedCallback /*Your callback to call if save fails*/,
                                a_newFileContentString /*The generated JSON data to send somewhere*/){
                                	//alert(a_newFileContentString);
                                	var inp = dom.byId('eat_div_input');
                                	inp.value = a_newFileContentString;
                                	a_saveCompleteCallback();
                                	};
                                	
    occu_grid_store._saveEverything = function(a_saveCompleteCallback /*Your callback to call when save is completed */,
                                a_saveFailedCallback /*Your callback to call if save fails*/,
                                a_newFileContentString /*The generated JSON data to send somewhere*/){
                                	//alert(a_newFileContentString);
                                	var inp = dom.byId('occu_div_input');
                                	inp.value = a_newFileContentString;
                                	a_saveCompleteCallback();
                                	};   


    
    var global_edit_allowed = true;
    
    var live_layout = [[
      {'name': 'Datum', 'field': 'requested_date', 'width': '100px', editable: global_edit_allowed},
      {'name': 'Tid', 'field': 'requested_time', 'width': '50px', editable:global_edit_allowed},      
      {'name': 'Bo tält', 'field': 'requested_activity', 'width': '100px', editable: global_edit_allowed},
      {'name': 'Bo inne', 'field': 'age_sma', 'width': '60px', editable:global_edit_allowed, type: dojox.grid.cells.Bool},  
      {'name': 'Bo dagsbesök', 'field': 'age_spar', 'width': '60px', editable:global_edit_allowed, type: dojox.grid.cells.Bool}
      
    ]];
    
    
var eat_layout = [[
      {'name': 'Datum', 'field': 'requested_date', 'width': '100px', editable: global_edit_allowed},
      {'name': 'Tid', 'field': 'requested_time', 'width': '50px', editable:global_edit_allowed},      
      {'name': 'Ute', 'field': 'age_spar', 'width': '60px', editable:global_edit_allowed, type: dojox.grid.cells.Bool},
      {'name': 'Inne', 'field': 'age_uppt', 'width': '60px', editable:global_edit_allowed, type: dojox.grid.cells.Bool},
      {'name': 'Egen', 'field': 'age_aven', 'width': '60px', editable:global_edit_allowed, type: dojox.grid.cells.Bool},
      
   
    ]];
	
var occu_layout = [[
      {'name': 'Datum', 'field': 'requested_date', 'width': '100px', editable: global_edit_allowed},
      {'name': 'Tid', 'field': 'requested_time', 'width': '50px', editable:global_edit_allowed},      
      {'name': 'Doktor', 'field': 'age_spar', 'width': '60px', editable:global_edit_allowed, type: dojox.grid.cells.Bool},
      {'name': 'Program', 'field': 'age_uppt', 'width': '60px', editable:global_edit_allowed, type: dojox.grid.cells.Bool},
      {'name': 'Kursdelt vö', 'field': 'age_aven', 'width': '60px', editable:global_edit_allowed, type: dojox.grid.cells.Bool},
      {'name': 'Kursdelt SSRS', 'field': 'age_aven', 'width': '60px', editable:global_edit_allowed, type: dojox.grid.cells.Bool}
    ]];

    //... create a new grid
   

	 var live_grid_grid = new DataGrid({
        id: 'live_grid',
        store: live_grid_store,
        structure: live_layout,
        rowSelector: '10px'});
        
        
    var eat_grid_grid = new DataGrid({
        id: 'eat_grid',
        store: eat_grid_store,
        structure: eat_layout,
        rowSelector: '10px'});
        
        
   var occu_grid_grid = new DataGrid({
        id: 'occu_grid',
        store: occu_grid_store,
        structure: occu_layout,
        rowSelector: '10px'});



    function on_save_grid_to_input() {
    	//...find dojo store and serialize it. Should be simple. Then write serialized data into 
    	//alert('storing...');
    	live_grid_store.save(saveCompleteCallback, saveFailedCallback);
    	eat_grid_store.save(saveCompleteCallback, saveFailedCallback);
    	occu_grid_store.save(saveCompleteCallback, saveFailedCallback);
    	
    	};
    	
    
    
    
    
    function on_validate() {
      var myForm = dijit.byId('myForm');
    	if(myForm.validate()){
            //var result = confirm('Form is valid, press OK to submit');
            
            return true;
        } else {
            alert('Form contains invalid data.  Please correct first');
            return false;
        }
        return true;
    }
    
    
    function on_validate_finalize() {
      var myForm = dijit.byId('myForm');
    	if(myForm.validate()){
            var result = confirm('Form is valid and ready to be sent for processing, pressing OK will submit your requests and thereafter you cannot change your request data except for contact info and request text');
            
            return result;
        } else {
            alert('Form contains invalid data.  Please correct first');
            return false;
        }
        return true;
    }
    
    
    function on_ready(){
      var save_button = dijit.byId('save_button');
      on( save_button , 'click', on_save_grid_to_input );
		on( save_button , 'click', on_validate); 
		
      // startup grid
		live_grid_grid.placeAt('live_grid_div');
      live_grid_grid.startup();
      eat_grid_grid.placeAt('eat_grid_div');
      eat_grid_grid.startup();
      occu_grid_grid.placeAt('occu_grid_div');
      occu_grid_grid.startup();
     
    }
    	
      ready(on_ready);
      
        
      
});

</script>

<script>
require(["dojo/parser", "dijit/form/Form", "dijit/form/Button", "dijit/form/ValidationTextBox", "dijit/form/DateTextBox"]);
</script>
</head>

<body class="tundra">
    <h2>Edit vodb group ${vodb_group.name}</h2>

	<p>Stays: <b>${reFormatDate(vodb_group.from_date)} - ${reFormatDate(vodb_group.to_date)}</b></p>
	<div class="note">
    Vodb status: <b>${bokn_status_map[vodb_group.vodb_status]}</b><br/>
    Contact info:<br/>
    <b>$vodb_group.vodb_contact_name</b><br/>
    <b>$vodb_group.vodb_contact_email</b><br/>
    <b>$vodb_group.vodb_contact_phone</b><br/>
    <b>$vodb_group.vodb_contact_address</b><br/>
    
    <p>${HTML(vodb_group.info)}</p>
</div>    
    <div data-dojo-type="dijit/form/Form" id="myForm" data-dojo-id="myForm" encType="multipart/form-data" action="update_visiting_group_program_request" method="post">

    <div>
    	<label for="live_grid_div">Live:</label><br/>        		
    	<div id="live_grid_div" style="height:300px;"><input type="hidden" id="live_grid_div_input" name="live_grid_input"/></div>
    	</div>
    
    	<div>    
    	<label for="eat_grid_div">Eat:</label><br/>
    	<div id="eat_grid_div" style="height:400px;"><input type="hidden" id="eat_grid_div_input" name="eat_grid_input"/></div>
    	</div>

    	<div>    
    	<label for="occu_grid_div">Occu:</label><br/>
    	<div id="occu_grid_div" style="height:400px;"><input type="hidden" id="occu_grid_div_input" name="occu_grid_input"/></div>
    	</div>

    
		<input type="hidden" name="vgroup_id" value="$vodb_group._id"/>
		<input type="hidden" name="program_request_info" id="program_request_info" />
    	<button data-dojo-type="dijit/form/Button" type="submit" name="saveButton" value="Save" id="save_button">Save</button>
	</div>
</body>
</html>