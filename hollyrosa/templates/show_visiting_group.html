<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--
Copyright 2010, 2011, 2012 Martin Eliasson

This file is part of Hollyrosa

Hollyrosa is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Hollyrosa is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with Hollyrosa.  If not, see <http://www.gnu.org/licenses/>.

-->

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:py="http://genshi.edgewall.org/" xmlns:xi="http://www.w3.org/2001/XInclude">

  <xi:include href="master.html" />

<head>
  <meta content="text/html; charset=UTF-8" http-equiv="content-type" py:replace="''"/>
  <title>Hollyrosa - Show Visiting Group ${visiting_group.name}</title>
  <link rel="stylesheet" type="text/css" href="${tg.url('/scripts/dojo-release-1.8.0/dijit/themes/tundra/tundra.css')}" />
  <script type="text/javascript" src="${tg.url('/scripts/std.js')}" ></script>
  <script src="${tg.url('/scripts/dojo-release-1.8.0/dojo/dojo.js')}" data-dojo-config="async: true" djConfig="parseOnLoad: true, debugAtAllCosts: true"></script>
  <script>

require(["dojo/ready", "tags", "common_menu", "dijit/Menu", "dojo/dom", "dojo/_base/array", "dojo/query!css2", "dojo/on", "dojo/_base/window"], function(ready, tags, common_menu, Menu, dom, array, query, on, win) {


function deleteTagHelper(evt) {
   var tag_elem = evt.srcElement.parentElement;
   var inner_text = tag_elem.innerText;
   inner_text = inner_text.replace(' (X)',''); 
   tags.deleteTag("${tg.url('/tag/delete_tag')}", "${visiting_group['_id']}", inner_text);
}


function addTagHelper() {
   tags.addTags("${tg.url('/tag/add_tags')}", "${visiting_group['_id']}", tag_input);
}

ready(function() {
	//...load all tags for visiting group
	tags.getTags("${tg.url('/tag/get_tags')}", "${visiting_group._id}");

   //...setup main menu for visiting group
   //var node = a_menu.currentTarget;
   //var vgid = node.attributes["hollyrosa:bid"].value;
  	
   var menu = new Menu({
       targetNodeIds: ["visiting_group_menu"],
       leftClickToOpen: false
       });
    
	common_menu.add_vgid_redirect_menu_item(menu, menu, "Edit visiting group", '${visiting_group['id']}', '${tg.url('edit_visiting_group')}');
   common_menu.add_list_bookings_redirect_menu_item(menu, menu, "List bookings", '${visiting_group['name']}', '${tg.url('/visiting_group/view_bookings_of_name')}');
   common_menu.add_note_redirect_menu_item(menu, menu, "Add note", '${visiting_group['id']}', '${tg.url('/note/add_note')}');
   common_menu.add_vgid_redirect_menu_item(menu, menu, "Show history", '${visiting_group['id']}', '${tg.url('/history/show')}');
   common_menu.add_vgid_redirect_menu_item(menu, menu, "New booking request", '${visiting_group['id']}', '${tg.url('/booking/edit_booking')}');
      
   //...attach the add tag handler
	var the_add_tag_href_elem = dom.byId('add_tag_href2');
	on(the_add_tag_href_elem, 'click', addTagHelper);
	
	//...link delete tag handler to any element with class .tag in document.
	on(win.doc, '.tag:click', deleteTagHelper);
	});
  });
  </script>
  


</head>

<body class="tundra">
    <h2>${visiting_group.name}</h2>
    
<!-- <ul class="any_menu context_inline_menu ">
       <li><a href="${tg.url('delete_visiting_group', params={'id':visiting_group.id})}">delete</a></li>
    </ul>
   -->
    
    <p>${reFormatDate(visiting_group.from_date)} to ${reFormatDate(visiting_group.to_date)}</p>
    


    <div class="note" id="visiting_group_menu"><div class="tag_list"><ul style="display:inline;" id="taglist" class="tag_list"></ul><form style="display:inline;"><input id="tag_input" type="text" name="tags" value="" />
<a id="add_tag_href2" href="javascript:;">Add Tags</a>
</form></div>
    <p>bok.nr: <b>${visiting_group.boknr}</b><br/>
    boknstatus: <b>${bokn_status_map.get(visiting_group.boknstatus,'')}</b><br/>
    camping location: <b>${visiting_group.camping_location}</b></p>${HTML(visiting_group.info)}</div>
    <div py:for="n in notes" >
            
        <div class="note2"><i>${n.timestamp} ${n.last_changed_by}</i><br/>
        <ul class="any_menu context_inline_menu ">
           <li><a href="${tg.url('/note/edit_note', params={'_id':n._id})}">edit</a></li>
           <li><a href="${tg.url('/note/add_note', params={'target_id':visiting_group._id})}">add note</a></li>
           <li><a href="${tg.url('/note/delete_note', params={'_id':n._id})}">delete</a></li>
        </ul>${HTML(n.text)}</div>
                
    </div>
    
    <p>${visiting_group.contact_person}<br/>$visiting_group.contact_person_phone<br/><a href="mailto:$visiting_group.contact_person_email">$visiting_group.contact_person_email</a><br/>
    </p> 

    
    

    <table class="data">
        <tr>
            <th>Property = Value Unit</th><th>Description</th><th>From date</th><th>To date</th>
        </tr>
        <tr py:for="prop in visiting_group.visiting_group_properties.values()">
            <td class="info">$$$prop.property = $prop.value $prop.unit</td><td class="info">$prop.description</td><td class="info">$prop.from_date</td><td class="info">$prop.to_date</td>
        </tr>
    </table>
    
    <h4>attachments:</h4>
    <ul py:for="at in visiting_group.get('_attachments',[])"><li><a href="${tg.url('download_attachment', params={'visiting_group_id':visiting_group._id, 'doc_id':at})}">${at}</a></li></ul>
    <form method="post" action="upload_attachment" enctype="multipart/form-data">
        <input type="file" name="file"/>
        <input type="hidden" name="vgrpid" value="${visiting_group.id}"/> 
        <input type="submit"/>
    </form>

    

        <div py:for="b in bookings">
        <h3><a href="${tg.url('/booking/view_activity', params={'activity_id':b.activity.id})}">${b.activity.title}</a></h3>
            
            <div py:if="None != b.booking_day">
                
                </div>
        
        
            <div py:if="None != b.booking_day" style="margin-left:2em;">
                
                
                
            </div>
            <div py:if="None == b.booking_day" style="margin-left:2em;">
                <span class="workflow_state_unscheduled">unscheduled</span>
                <ul class="any_menu context_inline_menu" style="padding-left:2em;">
                    
                    <li><a href="${tg.url('/booking/edit_booked_booking', params={'id':b._id})}">edit</a></li>
                    <li><a href="${tg.url('/booking/view_booked_booking', params={'id':b._id})}">view</a></li>
                    
                </ul>
            </div>
            <div style="margin-left:2em;">
                <div class="note"> ${getRenderContent(b)}</div>
            </div>
            
            
    
        </div>
</body>
</html>
