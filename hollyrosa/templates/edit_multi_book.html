<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--
Copyright 2010, 2011 Martin Eliasson

This file is part of Hollyrosa

Hollyrosa is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Hollyrosa is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with Hollyrosa.  If not, see <http://www.gnu.org/licenses/>.

-->

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:hollyrosa="http://asplunden.org/guldkant/hollyrosa" xmlns:py="http://genshi.edgewall.org/" xmlns:xi="http://www.w3.org/2001/XInclude">

  <xi:include href="master.html" />

<head>
  <meta content="text/html; charset=UTF-8" http-equiv="content-type" py:replace="''"/>
  <title>Hollyrosa - ${booking.activity.title} booking</title>
  
  <script type="text/javascript" src="${tg.url('/scripts/dojo-release-1.5.0/dojo/dojo.js')}" ></script>
  <script type="text/javascript">
  

function draw_booked_slot(booking_day_id, slot_row_id, activity_id, visiting_group_id, text, booking_id, slot_row_position_state) {
    var booking_container = dojo.query('[hollyrosa:bk$="'+booking_day_id+':'+slot_row_id+'"]');
    
    booking_div = dojo.create('div', {style:"border-bottom:1px dashed #ccc;", id:"booking_id_"+booking_id}, booking_container[0]);
    booking_span = dojo.create('span', {class:"workflow_state_0"}, booking_div);
    dojo.create('a', {href:"\"${tg.url('/visiting_group/view_bookings_of_name', name=booking.visiting_group_name)}\"", innerHTML:"${booking.visiting_group_name}"}, booking_span); 
    dojo.create('br', null, booking_div);
    dojo.create('a', {href:"${tg.url('view_booked_booking')}" + "id="+booking_id, style:"padding-left:2em;", innerHTML:text}, booking_div);
    menu_ul = dojo.create('ul', {class:"any_menu context_inline_menu"}, booking_div);
    tmp_li = dojo.create('li', {}, menu_ul);
    dojo.create('a', {innerHTML:'edit', href:"edit_booked_booking?id="+booking_id}, tmp_li);
    tmp_li = dojo.create('li', {}, menu_ul);
    dojo.create('a', {innerHTML:'view', href:"view_booked_booking?id="+booking_id}, tmp_li);
    tmp_li = dojo.create('li', {}, menu_ul);
    dojo.create('a', {innerHTML:'delete', href:"javascript:delete_booking(" + booking_id + ");"}, tmp_li);
    tmp_li = dojo.create('li', {}, menu_ul);
    dojo.create('a', {innerHTML:'unschedule', href:"javascript:unschedule_booking(" + booking_id +");"}, tmp_li);
    
    //...create menu with delete | unschedule etc
    
    if (0 != slot_row_position_state) {
        var e = dojo.query('[hollyrosa:bj$="'+booking_day_id+':'+slot_row_id+'"]');
        dojo.addClass(e[0],'slot_row_position_blocked');
    }
}


function on_booking_confirmed(response_data) {
    var booking = response_data['booking'];
    var error_msg = response_data['error_msg'];
    if (error_msg) {
        alert(error_msg);
    }
    else {
        var slot_row_position_state = response_data['slot_row_position_state'];
        draw_booked_slot(response_data['booking_day_id'], response_data['slot_row_position_id'], booking.activity_id, booking.visiting_group_id, booking.cache_content, booking.id, slot_row_position_state);
    }
}
  
 
function book_slot(me, booking_day_id, slot_row_position_id, activity_id, visiting_group_id) {
    
    dojo.byId('req_form_booking_day_id').value =  booking_day_id;
    dojo.byId('req_form_slot_row_position_id').value = slot_row_position_id;
    
    //...show form centered over slot
    
    
    var the_form = dojo.byId('booking_req_form');
    var booking_container = dojo.query('[hollyrosa:bk=' + booking_day_id + ':' + slot_row_position_id+']' );
    var cpos = dojo.position(booking_container[0], true);
    
    
    
    dojo.style(the_form, "position", "absolute");
    dojo.style(the_form, "top", cpos.y + 'px');
    dojo.style(the_form, "left", cpos.x + 'px');
    
    dojo.style(the_form, "display","block");
}
    

function cancel_book_stage_2() {
    var the_form = dojo.byId('booking_req_form');
    dojo.style(the_form, "display","none");
}

function book_slot_stage_2()
{
    dojo.xhrGet({
    url: "/hollyrosa/booking/create_booking_async",
    handleAs:"json",
    form:"booking_req_form",
    load: on_booking_confirmed
    });
    the_form = dojo.byId('booking_req_form');
    dojo.style(the_form, "display","none");
    //book_slot(booking_day_id, slot_row_position_id, activity_id, visiting_group_id, "new boking should be inserted here");
}


function on_booking_deleted(response_data) {
    var booking = response_data['delete_req_booking_id'];
    var to_remove = dojo.byId('booking_id_' + booking);
    dojo.destroy(to_remove);
}


function delete_booking(booking_id, activity_id, visiting_group_id)
{
    dojo.byId('delete_req_booking_id').value =  booking_id;
    dojo.xhrGet({
    url: "/hollyrosa/booking/delete_booking_async",
    handleAs:"json",
    form:"delete_booking_form",
    load: on_booking_deleted
    });
}


function unschedule_booking(booking_id, activity_id, visiting_group_id)
{
    dojo.byId('delete_req_booking_id').value =  booking_id;
    dojo.xhrGet({
    url: "/hollyrosa/booking/unschedule_booking_async",
    handleAs:"json",
    form:"delete_booking_form",
    load: on_booking_deleted
    });
}



  </script>
</head>
<body>
    <form name="booking_req_form" id="booking_req_form" method="get" style="display:none; backgroud:#fff;">
        <div style="background:#fff;">
        <fieldset>  
        <legend>Enter ${booking.activity.title} details</legend>
        <input type="hidden" name="booking_day_id" id="req_form_booking_day_id" />
        <input type="hidden" name="slot_row_position_id" id="req_form_slot_row_position_id"/>
        <input type="hidden" name="visiting_group_id" value="$booking.visiting_group_id"/>
        <input type="hidden" name="activity_id" value="$booking.activity.id"/>
        <textarea name="content" rows="5" cols="40">${booking.content}</textarea><br/>
        <input type="checkbox" name="block_after_book"/>Block after book<br/><br/>
        <input type="button" value="book" onclick="book_slot_stage_2();"/>
        <input type="button" value="cancel" onclick="cancel_book_stage_2();"/>
        </fieldset>
        </div>
    </form>
    <form name="delete_booking_form" id="delete_booking_form" method="get" >
        <input type="hidden" name="delete_req_booking_id" id="delete_req_booking_id" />
        <input type="hidden" name="visiting_group_id" value="$booking.visiting_group_id"/>
        <input type="hidden" name="activity_id" value="$booking.activity.id"/>
    </form>
    
    <h2>${booking.activity.title} booking</h2>
    <h3>${booking.visiting_group_name}</h3> 
       
        
    <ul class="any_menu context_inline_menu">
        <li py:if="None !=booking_day"><a href="${tg.url('/booking/edit_booked_booking', return_to_day_id=booking.booking_day_id, id=booking.id)}">edit</a></li>
        <li py:if="None ==booking_day"><a href="${tg.url('/booking/edit_booking', return_to_day_id=booking.booking_day_id, id=booking.id)}">edit</a></li>
        <li py:if="None !=booking_day"><a href="${tg.url('/booking/unschedule_booking', booking_day_id=booking.booking_day_id, booking_id=booking.id)}">unschedule</a></li>
        <li py:if="None !=booking_day"><a href="${tg.url('/workflow/set_state', booking_id=booking.id, state=0)}">preliminary</a></li>
        <li py:if="None !=booking_day"><a href="${tg.url('/workflow/set_state', booking_id=booking.id, state=10)}">booked</a></li>
        <li py:if="None !=booking_day"><a href="${tg.url('/workflow/set_state', booking_id=booking.id, state=20)}">approve</a></li>
        <li py:if="None !=booking_day"><a href="${tg.url('/workflow/set_state', booking_id=booking.id, state=-10)}">disapprove</a></li>
        <li py:if="None !=booking_day"><a href="${tg.url('/booking/multi_book', booking_id=booking.id)}">multi-book</a></li>
    </ul>
    
    <div class="note">${getRenderContent(booking)}</div>
    <h3>$booking.activity.title</h3>
    
    <!-- iterate over all days, one div for each -->
    <div py:for="tmp_day in booking_days">
        <div class="booking_day_overview_slot_row" style="background: ${slot_row.activity.bg_color};">
            <div class="booking_day_overview_activity"><a href="${tg.url('/booking/day', day_id=tmp_day.id)}">${tmp_day.date.strftime("%A %B %d")}</a></div>
    
            <div py:for="slot_position in slot_row.slot_row_position" hollyrosa:w="$slot_position.time_from - $slot_position.time_to" class="booking_day_overview_slots ${['','slot_row_position_blocked'][blockings_map.has_key(str(tmp_day.id)+':'+str(slot_position.id))]}" hollyrosa:bj="${tmp_day.id}:${slot_position.id}">
            <!-- we may have several slot bookings-->
            <div py:if="bookings[tmp_day.id].has_key(slot_position.id)" hollyrosa:bk="${tmp_day.id}:${slot_position.id}">
            
            
                <div py:for="b in bookings[tmp_day.id][slot_position.id]" style="border-bottom:1px dashed #ccc;" id="booking_id_$b.id">
                <span class="workflow_state_${b.booking_state}"><a href="${tg.url('/visiting_group/view_bookings_of_name', name=b.visiting_group_name)}">${b.visiting_group_name}</a></span><br/><a href="${tg.url('view_booked_booking', id=b.id)}" style="padding-left:2em;">${getRenderContent(b)}</a>
                <ul class="any_menu context_inline_menu">
                        <li><a href="${tg.url('edit_booked_booking', return_to_day_id=tmp_day.id, id=b.id)}">edit</a></li>
                        <li><a href="${tg.url('view_booked_booking', return_to_day_id=tmp_day.id, id=b.id)}">view</a></li>
                        <li><a href="javascript:delete_booking(${b.id});">delete</a></li>
                        <li><a href="javascript:unschedule_booking(${b.id});">unschedule</a></li>
                    </ul>
                
                </div>
            </div>
            <div py:if="not bookings[tmp_day.id].has_key(slot_position.id)" hollyrosa:bk="${tmp_day.id}:${slot_position.id}" />
            
            <div py:if="blockings_map.has_key(str(tmp_day.id)+':'+str(slot_position.id))">&nbsp;</div>
            <ul id="minimenu_${slot_position.id}" class="context_inline_menu any_menu">
                <li py:if="not blockings_map.has_key(str(tmp_day.id)+':'+str(slot_position.id))"><a href="javascript:book_slot(this, ${tmp_day.id} ,${slot_position.id},${booking.activity.id}, ${booking.visiting_group_id});">book</a></li>
                <!-- <li><a  py:if="not blockings_map.has_key(slot_position.id)" href="${tg.url('book_slot', booking_day_id=booking_day.id, slot_position_id=slot_position.id)}">book</a></li> -->
                <!-- <li><a py:if="not blockings_map.has_key(slot_position.id)" href="${tg.url('block_slot', booking_day_id=booking_day.id, slot_row_position_id=slot_position.id)}">block slot</a></li> -->
                <!-- <li><a py:if="blockings_map.has_key(slot_position.id)" href="${tg.url('unblock_slot', booking_day_id=booking_day.id, slot_row_position_id=slot_position.id)}">unblock slot</a></li> -->
            </ul>
            </div>
        </div>
    </div>
    
    

</body>
</html>
