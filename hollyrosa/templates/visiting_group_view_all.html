<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!--
Copyright 2010, 2011, 2012, 2013, 2014 Martin Eliasson

This file is part of Hollyrosa

Hollyrosa is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Hollyrosa is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with Hollyrosa.  If not, see <http://www.gnu.org/licenses/>.

-->

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:py="http://genshi.edgewall.org/" xmlns:hollyrosa="http://asplunden.org/guldkant/hollyrosa" xmlns:xi="http://www.w3.org/2001/XInclude">

  <xi:include href="master.html" />

<head>
  <meta content="text/html; charset=UTF-8" http-equiv="content-type" py:replace="''"/>
  <title>Hollyrosa - Viewing Visiting Groups</title>

  
  <link rel="stylesheet" type="text/css" href="${tg.url('/scripts/dojo-release-1.8.0/dijit/themes/tundra/tundra.css')}" />
  <script type="text/javascript" src="${tg.url('/scripts/std.js')}" ></script>
  
  <script src="${tg.url('/scripts/dojo-release-1.8.0/dojo/dojo.js')}" data-dojo-config="async: true"></script>
  <script>
require(["common_menu", "tags", "dojo/_base/array", "dijit/registry","dijit/Menu","dijit/MenuItem","dijit/PopupMenuItem", "dojo/query!css2", "dojo/io-query", "dojo/dom", "dojo/dom-construct", "dojo/request/xhr"], function(common_menu, tags, array, registry, Menu, MenuItem, PopupMenuItem, xq, ioQuery, dom, domConstruct, xhr) {


function updateNotes(data) {
    var vgroup_id = data['id'];
    var load_note_link = dom.byId('load_notes_for_' + vgroup_id);
    domConstruct.destroy(load_note_link);
    
    var notes = data['notes'];
    for (n in notes) {
        note = notes[n];
        var notes_for_id = 'notes_for_' + note['target_id'];
        
        e = dom.byId(notes_for_id);
        var note_div = domConstruct.create("div", {innerHTML: note['text'], class:note['type']+'2'}, e);
		  if (note['type'] == 'attachment') {        
        		var note_div2 = domConstruct.create("div", {}, note_div);
			        
        		var attachments = note['_attachments'];
        		var keys = Object.keys(attachments); 
        		array.forEach(keys, function(key) {
					var ioq = {
                       attachment_id: note._id,
                       doc_id: key
                   };        
                
					var ul = domConstruct.create("ul", {}, note_div2);
					var li = domConstruct.create("li", {}, ul);
					  
					domConstruct.create("a", {href:'${tg.url('/note/download_attachment')}' + '?' + ioQuery.objectToQuery(ioq), innerHTML: key}, li);
        			}); 
			}
    }
}



/** need to fix this deleteTagHelper so it **/
function deleteTagHelper(evt) {
   var tag_elem = evt.srcElement.parentElement;
   var inner_text = tag_elem.innerText;
   inner_text = inner_text.replace(' (X)',''); 
   var visiting_group_id = evt.node.attributes['hollyrosa:vgid'];
   tags.deleteTag("${tg.url('/tag/delete_tag')}", visiting_group_id, 'taglist',inner_text);
}


var tag_dialog = tags.createAddTagDialog( '${tg.url('/tag/add_tags')}', tags.updateTagsCloseDialog );


function show_add_tag_dialog(node_id) {
    var visiting_group_id = node_id.attributes['hollyrosa:vgid'].value;
    tags.showAddTagDialog(tag_dialog, visiting_group_id, node_id.attributes['hollyrosa:taglist_node_id'].value);
}


function loadNotesFor(id) {   
    xhr("${tg.url('/note/get_notes_for_visiting_group')}", {
    query: {id: id},
    handleAs: 'json',
    method: "GET"}).then( updateNotes );
	}
	
	
   var menu = new Menu({
       targetNodeIds: ["vgroup_listing"],
       selector: "tr.name_menu",
       leftClickToOpen: common_menu.load_left_click_menu(),
       onOpen: function(evt) {
       	var node = menu.currentTarget;
         var has_notes = node.attributes["hollyrosa:has_notes"].value;
         console.log( has_notes );
         
         if (has_notes == 'True') {
         	load_notes_menu_item.disabled = false;
         } else {
	         load_notes_menu_item.disabled = true;
	     } 
       } // end function
       });

   common_menu.add_visiting_group_menu_item(menu, menu, "New booking request...", '${tg.url('/booking/edit_booking')}');
   common_menu.add_menu_separator(menu);   
   common_menu.add_visiting_group_menu_item(menu, menu, "View...", '${tg.url('show_visiting_group')}');
   common_menu.add_visiting_group_menu_item(menu, menu, "Edit...", '${tg.url('edit_visiting_group')}');
   common_menu.add_visiting_group_menu_item(menu, menu, "Ext. Booking Request", '${tg.url('/visiting_group_program_request/edit_request')}');
   common_menu.add_visiting_group_list_bookings_menu_item(menu, menu, "List bookings of group...", '${tg.url('view_bookings_of_name')}');
   common_menu.add_visiting_group_menu_item(menu, menu, "Program layers...", '${tg.url('layers')}');
   common_menu.add_visiting_group_menu_item(menu, menu, "Calendar layers...", '${tg.url('layers_printable')}');
   common_menu.add_visiting_group_menu_item(menu, menu, "Edit layers...", '${tg.url('edit_layers')}');
   common_menu.add_menu_separator(menu);
   common_menu.add_call_function_menu_item(menu, menu, "Add tags...",  show_add_tag_dialog  );
   common_menu.add_visiting_group_add_note_menu_item(menu, menu, "Add note...", '${tg.url('/note/add_note')}');
   common_menu.add_visiting_group_add_note_menu_item(menu, menu, "Add attachment...", '${tg.url('/note/add_attachment')}');
       
   var load_notes_menu_item = new MenuItem({
       label: "Load notes",
       onClick: function(evt) {
           var node = this.getParent().currentTarget;
           var vgroup_id = node.attributes["hollyrosa:vgid"].value;
           loadNotesFor(vgroup_id);
           
           //...this isn't bulletproof, should be in a callback after the notes have loaded.
           var node = menu.currentTarget;
           node.attributes["hollyrosa:has_notes"].value = "False";
           }
       });
   menu.addChild(load_notes_menu_item);
   
   common_menu.add_menu_separator(menu);   
   common_menu.add_visiting_group_menu_item(menu, menu, "Show history...", '${tg.url('/history/show')}');   
   
       
   /* assemblingthe filter booking status menu */
   var filter_menu = new Menu({
       targetNodeIds: ["bokn_status_menu"],
       leftClickToOpen: common_menu.load_left_click_menu()
       });
       
   var bokn_status_menu = new Menu();
   filter_menu.addChild(new PopupMenuItem({
   	label: "Program status...",
      popup: bokn_status_menu,
      leftClickToOpen: common_menu.load_left_click_menu()
   })); 
   
   var vodb_state_menu = new Menu();
   filter_menu.addChild(new PopupMenuItem({
   	label: "VODB status...",
      popup: vodb_state_menu,
      leftClickToOpen: common_menu.load_left_click_menu()
   })); 
   
   var tag_menu = new Menu();
   filter_menu.addChild(new PopupMenuItem({
   	label: "Tags...",
      popup: tag_menu,
      leftClickToOpen: common_menu.load_left_click_menu()
   })); 

   var date_range_menu = new Menu();
   filter_menu.addChild(new PopupMenuItem({
   	label: "Date range...",
      popup: date_range_menu,
      leftClickToOpen: common_menu.load_left_click_menu()
   })); 

   
   var l1 = ${ '['+ ','.join( ['["'+str(k)+'","'+v+'"]'  for k,v in program_state_map.items()] ) +']' };
   var l2 = ${ '['+ ','.join( ['["'+str(k)+'","'+v+'"]'  for k,v in vodb_state_map.items()] ) +']' };
   
   array.forEach(l1, function(l) {     
   	common_menu.add_redirect_menu_item(filter_menu, bokn_status_menu, l[1], {program_state:l[0]}, '${tg.url('view_program_state')}');   
   });
   
   array.forEach(l2, function(l) {     
   	common_menu.add_redirect_menu_item(filter_menu, vodb_state_menu, l[1], {'vodb_state':l[0]}, '${tg.url('view_vodb_state')}');   
   });
   
   var all_tags = ${ '[' + ''.join(['"'+l+'", ' for l in all_tags]  ) +']' };
   array.forEach(all_tags, function(l) { 
       common_menu.add_redirect_menu_item(filter_menu, tag_menu, l, {tag:l}, '${tg.url('view_tags')}');   
   });
   /* assembling the filter tag menu */
   
    on(win.doc, '.tag:click', deleteTagHelper);
   
   });
  
  </script>
  <script type="text/javascript">

require(["dojo/_base/array", "dojo/dom-construct", "dojo/query!css2", "dojo/dom", "dojo/request/xhr", "dojo/on", "dojo/ready"], function(array, domConstruct, query, dom, xhr, on, ready) {


function updateUnboundNames(data) {

    query('.unbound_names').forEach(domConstruct.destroy);
    var names = data['names'];
    var ul_unbound_names_list = dom.byId("unbound_names");
 
    for (n in names) {
        var ne = escape(n);
        domConstruct.create("li", {innerHTML: '<a href="view_bookings_of_name?name=' + ne + '">' + n +'</a>', class:'unbound_names'}, ul_unbound_names_list);
    }
    dom.byId('tag_input').value = '';
}

  
function getUnboundNames() {   
    xhr("${tg.url('/tag/get_unbound_visiting_group_names')}", {
    handleAs: "json",
    method: "GET"}).then(function(data){updateUnboundNames(data);});
}


function loadNotesFor(id) {   
    xhr("${tg.url('/note/get_notes_for_visiting_group')}", {
    query: {'id': id},
    handleAs: "json",
    method: "GET"}).then(function(data){ updatedNotes(data); })
	}


});  
  </script>

</head>

<body class="tundra">
    Choose time period: <ul class="any_menu">

        <li><a href="${tg.url('view_today')}">today</a></li>
        <li id="bokn_status_menu" class="context_menu_symbol">Filter booking status</li>
        

    
    </ul>
    <h2>Viewing visiting groups</h2>
    <table id="vgroup_listing">
        <tr py:for="visiting_group in visiting_groups" class="name_menu" hollyrosa:vgid="${visiting_group._id}" hollyrosa:taglist_node_id="taglist_for_${hash(visiting_group._id)}" hollyrosa:vgname="${visiting_group.name}" hollyrosa:has_notes="${has_notes_map.has_key(visiting_group._id)}">
            <td class="info data context_menu_symbol">${visiting_group.name}<a name="vgroupid_${visiting_group._id}"/></td>
            <td class="info data context_menu_symbol">[${reFormatDate(visiting_group.from_date)} to ${reFormatDate(visiting_group.to_date)}]<br/><br/>${visiting_group.get('contact_person','')}<br/>${visiting_group.get('contact_person_phone','')}<br/><a href="mailto:${visiting_group.get('contact_person_email','')}">${visiting_group.get('contact_person_email','')}</a></td>
            <td class="info data context_menu_symbol">
            <div class="note"><ul class="tag_list" id="taglist_for_${hash(visiting_group._id)}" py:for="tag in visiting_group.get('tags',[])"><li><a href="javascript:;" class="tag">$tag (X)</a></li></ul>
            <p>bok.nr: <b>${visiting_group.boknr}</b> <br/>
            vodb status: <b>${vodb_state_map.get(visiting_group.get('vodbstatus','-'), '')}</b><br/>
            program status: <b>${program_state_map.get(visiting_group.boknstatus, '')}</b><br/>
            camping location: <b>${visiting_group.camping_location}</b></p>${HTML(visiting_group.info)}</div>
            
            <div id="notes_for_${visiting_group._id}"><!-- <a py:if="has_notes_map.has_key(visiting_group._id)" id="load_notes_for_${visiting_group._id}" hollyrosa:loadnotes="${visiting_group._id}">--> <span py:if="has_notes_map.has_key(visiting_group._id)" id="load_notes_for_${visiting_group._id}">has notes, load using the context menu</span></div>            
            </td>
        </tr>
    </table>
    <h2>Visiting group names used that not is in any registered group</h2>
    <p><a class="unbound_names" href="javascript:getUnboundNames();">load unbound names</a></p>
    <ul id="unbound_names">
        <li py:for="v in remaining_visiting_group_names">"${v}" <a href="${tg.url('view_bookings_of_name', params={'name':v})};">List all activities</a></li>
    </ul>
</body>
</html>
